<!-- anime.html ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∞–π—Ç–ª–∞ -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶ | –ê–Ω–∏–º–µ–°–∞–π—Ç</title>

    <!-- –≤–∞—à –æ–±—â–∏–π CSS-—Ñ–∞–π–ª  -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–ø–æ –º–∏–Ω–∏–º—É–º—É) -->
    <style>
        .anime-wrapper   {display:flex;flex-wrap:wrap;gap:20px;background:#fff;padding:20px;max-width:1200px;margin:auto}
        .anime-img       {width:300px;flex-shrink:0;border-radius:8px;object-fit:cover}
        .anime-meta h1   {font-size:32px;margin:0 0 10px}
        .anime-meta .rating{color:#FFD700;font-size:2em;margin-bottom:10px}
        .anime-meta p    {margin:4px 0;font-size:16px}
        .description     {background:#fff;border-radius:10px;padding:20px;max-width:1200px;margin:25px auto}
        .add-to-cart     {margin-top:20px;padding:12px 20px;background:#007BFF;color:#fff;border:none;border-radius:6px;cursor:pointer}
        .add-to-cart:hover{background:#0056b3}
    </style>
</head>

<body>
    <header class="site-header">
        <div class="logo">–ê–Ω–∏–º–µ–°–∞–π—Ç</div>
  
        <div class="search-container" role="search">
          <form id="searchForm" class="search-form" autocomplete="off" aria-label="–ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="–ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
              aria-autocomplete="list"
              aria-controls="suggestions"
              aria-expanded="false"
            />
            <button type="submit" class="search-button" aria-label="–ù–∞–π—Ç–∏">üîç</button>
          </form>
          <ul id="suggestions" class="autocomplete-suggestions" role="listbox" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞"></ul>
        </div>
  
        <nav class="main-nav" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <ul>
            <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li><a href="top100.html">–¢–æ–ø-100 –∞–Ω–∏–º–µ</a></li>
            <a href="cart.html" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="counter">0</span> </a>
            <li>
              <a href="profile.html" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
                <img src="img/avatar.jpg" alt="" class="avatar" />
              </a>
            </li>
          </ul>
        </nav>
      </header>

<main>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π—Ç–ª–∞ -->
    <section id="animeSection">
        <p style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
    </section>

    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ -->
    <section id="descriptionSection" class="description" hidden>
        <h2>–û–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞</h2>
        <p id="animeDescription"></p>
    </section>
</main>

<footer>
    <div>
        <p>&copy; 2024 –ê–Ω–∏–º–µ–°–∞–π—Ç.</p>
        <p>
          <a href="https://t.me" style="color: white; text-decoration: none;">–ù–∞—à –∫–∞–Ω–∞–ª –≤ Telegram</a> |
          <a href="about.html" style="color: white; text-decoration: none;">–û –Ω–∞—Å</a> |
          <a href="add-item.html" style="color: white; text-decoration: none;">–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–µ</a>
        </p>
    </div>
</footer>

<script type="module">
    /* –æ–±—â–∏–π –º–æ–¥—É–ª—å –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ --------------------------------- */
    import { getFavSet, saveFavSet, updateFavCounter } from './js/fav-storage.js';
    
    /* -------------------- –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -------------------- */
    function qs(name, url = window.location.href) {
      name = name.replace(/[\\[\\]]/g, '\\$&');
      const m = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)').exec(url);
      return m && m[2] ? decodeURIComponent(m[2].replace(/\\+/g, ' ')) : null;
    }
    
    /* -------------------- –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π—Ç–ª–∞ -------------------- */
    (async function init() {
      const id = qs('id');
      if (!id) {
        document.getElementById('animeSection').innerHTML = '<p>–ù–µ —É–∫–∞–∑–∞–Ω ID –∞–Ω–∏–º–µ.</p>';
        return;
      }
      try {
        const res = await fetch(`/api/anime/${id}`);
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ ' + res.status);
        const a = await res.json();
    
        document.title = a.title + ' | –ê–Ω–∏–º–µ–°–∞–π—Ç';
        renderAnime(a);
    
        /* –≤—ã–≤–æ–¥–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –∏–∑ localStorage */
        updateFavCounter();
    
        /* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º, –µ—Å–ª–∏ –æ–Ω –≤–µ–¥—ë—Ç —Å–≤–æ—é –∫–æ—Ä–∑–∏–Ω—É */
        syncWithServerCount();
      } catch (err) {
        document.getElementById('animeSection').innerHTML = `<p>${err.message}</p>`;
      }
    })();
    
    /* ---------- —Ä–µ–Ω–¥–µ—Ä –∞–Ω–∏–º–µ ---------- */
    function renderAnime(a) {
      const section = document.getElementById('animeSection');
      section.innerHTML = `
        <div class="anime-wrapper">
          <img src="${a.imagePath}" alt="${a.title}" class="anime-img">
          <div class="anime-meta">
            <h1>${a.title}</h1>
            <div class="rating">‚≠ê ${a.rating}</div>
            <p><strong>–¢–∏–ø:</strong> ${a.type}</p>
            <p><strong>–≠–ø–∏–∑–æ–¥—ã:</strong> ${a.episodes}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${a.status}</p>
            <p><strong>–ñ–∞–Ω—Ä—ã:</strong> ${a.genres.join(' / ')}</p>
            <p><strong>–°—Ç—É–¥–∏—è:</strong> ${a.studio}</p>
            <p><strong>–ì–æ–¥:</strong> ${a.year}</p>
            <button class="add-to-cart" data-anime-id="${a.id}">
              –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            </button>
          </div>
        </div>`;
    
      if (a.description) {
        document.getElementById('descriptionSection').hidden = false;
        document.getElementById('animeDescription').textContent = a.description;
      }
    }
    
    /* -------------------- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ -------------------- */
    document.body.addEventListener('click', e => {
      /* –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ */
      if (!e.target.matches('.add-to-cart')) return;
    
      const id = +e.target.dataset.animeId;
    
      fetch('/api/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ animeId: id })
      })
      .then(r => r.ok ? r.json() : r.text().then(t => Promise.reject(t)))
      .then(data => {
        /* —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äì —Ä–∏—Å—É–µ–º –µ–≥–æ */
        updateFavCounter(data.totalItems);
    
        /* –∫–ª–∞–¥—ë–º ID –≤ localStorage, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ —É–≤–∏–¥–µ–ª–∞ —Ç–æ –∂–µ */
        const set = getFavSet();
        set.add(id);
        saveFavSet(set);
      })
      .catch(err => alert(err));
    });
    
    /* ---------- –ø–æ–∏—Å–∫ –ø–æ —Å–∞–π—Ç—É ---------- */
    document.getElementById('searchForm').addEventListener('submit', e => {
      e.preventDefault();
      const term = document.getElementById('searchInput').value.trim();
      if (term) location.href = `catalog.html?search=${encodeURIComponent(term)}`;
    });
    
    /* ---------- —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---------- */
    function syncWithServerCount() {
      fetch('/api/cart/count', { credentials: 'include' })
        .then(r => r.ok ? r.json() : { totalItems: 0 })
        .then(d => updateFavCounter(d.totalItems))
        .catch(() => updateFavCounter());
    }
    </script>
</body>
</html>
