<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ç–∞–ª–æ–≥ - –ê–Ω–∏–º–µ–°–∞–π—Ç</title>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
.anime-item{
  width:220px;
  height:480px;                 /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
  display:grid;
  grid-template-rows:300px auto 48px; /* –∫–∞—Ä—Ç–∏–Ω–∫–∞ ¬∑ —Ç–µ–∫—Å—Ç ¬∑ –∫–Ω–æ–ø–∫–∞ */
  row-gap:8px;
  overflow:hidden;
  border-radius:10px;
  background:#fff;
  box-shadow:0 2px 12px rgba(0,0,0,.08);
  margin:10px;
  cursor:pointer;
}

/* ‚îÄ‚îÄ –ö–∞—Ä—Ç–∏–Ω–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.anime-img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ‚îÄ‚îÄ –ë–ª–æ–∫ —Å —Ç–µ–∫—Å—Ç–æ–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.anime-info{
  /* –±—ã–ª–æ: margin-top:10px;  ‚Äî —É–±–∏—Ä–∞–µ–º! */
  margin-top:0;          /* ‚Üê‚Äì‚Äì –∫–ª—é—á–µ–≤–∞—è –ø—Ä–∞–≤–∫–∞ */
  padding:8px;
  display:grid;
  gap:4px 0;
  grid-template-rows:24px 18px 34px 38px; /* title / meta / genres / desc */
  overflow:hidden;
  text-align:left;
  background:#fff;       /* –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –º–∞—Å–∫–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ
                            —Å–ª—É—á–∞–π–Ω–æ –≤–µ—Ä–Ω—ë—Ç margin-top */
}

/* ‚îÄ‚îÄ –û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.title{
  font:600 18px/1.2 system-ui,sans-serif;
  margin:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;       /* 1 —Å—Ç—Ä–æ–∫–∞ + ¬´‚Ä¶¬ª */
}

.meta{
  display:flex;
  align-items:center;  /* ‚Üê –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç—Ä–æ–∫–∏ */
  gap:10px;
  font-size:14px;
}

.genre-info,
.description{
  font-size:14px;
  line-height:1.2;
  display:-webkit-box;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.genre-info{
  -webkit-line-clamp:2;         /* 2 —Å—Ç—Ä–æ–∫–∏ + –æ–±—Ä–µ–∑–∫–∞ */
}

.description{
  line-height:1.35;
  -webkit-line-clamp:2;         /* 2 —Å—Ç—Ä–æ–∫–∏ + –æ–±—Ä–µ–∑–∫–∞ */
}

/* ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.actions{
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fafafa;
}

.fav-btn{
  background:transparent;
  border:none;
  font-size:14px;
  cursor:pointer;
  transition:transform .15s;
}
.fav-btn:hover{ transform:scale(1.05); }
      </style>
  </head>
  <body>
    <header class="site-header">
      <div class="logo">–ê–Ω–∏–º–µ–°–∞–π—Ç</div>

      <div class="search-container" role="search">
        <form id="searchForm" class="search-form" autocomplete="off" aria-label="–ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="–ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            aria-autocomplete="list"
            aria-controls="suggestions"
            aria-expanded="false"
          />
          <button type="submit" class="search-button" aria-label="–ù–∞–π—Ç–∏">üîç</button>
        </form>
        <ul id="suggestions" class="autocomplete-suggestions" role="listbox" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞"></ul>
      </div>

      <nav class="main-nav" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
        <ul>
          <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
          <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
          <li><a href="top100.html">–¢–æ–ø-100 –∞–Ω–∏–º–µ</a></li>
          <a href="cart.html" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="counter">0</span> </a>
          <li>
            <a href="profile.html" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
              <img src="img/avatar.jpg" alt="" class="avatar" />
            </a>
          </li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="main-container">
        <div class="anime-results" aria-labelledby="results-title">
          <h1 id="results-title" class="visually-hidden">–ö–∞—Ç–∞–ª–æ–≥ –∞–Ω–∏–º–µ</h1>
          <div id="results" class="anime-list"></div>
          <div id="pagination" class="pagination"></div>
        </div>

        <aside class="navbar" aria-label="–§–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–Ω–∏–º–µ">
          <div class="filter-container">
            <p><strong class="filter-title">–§–∏–ª—å—Ç—Ä—ã</strong></p>
            <div class="search-filters">
              <!-- –ñ–∞–Ω—Ä—ã -->
              <div class="filter-group">
                <label>–ñ–∞–Ω—Ä—ã:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="genreDropdownButton" data-selected="–õ—é–±–æ–π">–õ—é–±–æ–π</button>
                  <div class="dropdown-content" id="genreDropdown">
                    <a href="#" data-value="–õ—é–±–æ–π">–õ—é–±–æ–π</a>
                    <a href="#" data-value="–≠–∫—à–µ–Ω">–≠–∫—à–µ–Ω</a>
                    <a href="#" data-value="–ö–æ–º–µ–¥–∏—è">–ö–æ–º–µ–¥–∏—è</a>
                    <a href="#" data-value="–§—ç–Ω—Ç–µ–∑–∏">–§—ç–Ω—Ç–µ–∑–∏</a>
                    <a href="#" data-value="–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</a>
                    <a href="#" data-value="–î—Ä–∞–º–∞">–î—Ä–∞–º–∞</a>
                  </div>
                </div>
              </div>
              <!-- –ò—Å–∫–ª—é—á–∏—Ç—å –∂–∞–Ω—Ä—ã -->
              <div class="filter-group">
                <label>–ò—Å–∫–ª—é—á–∏—Ç—å –∂–∞–Ω—Ä—ã:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="excludeGenreDropdownButton" data-selected="–ù–µ—Ç">–ù–µ—Ç</button>
                  <div class="dropdown-content" id="excludeGenreDropdown">
                    <a href="#" data-value="–ù–µ—Ç">–ù–µ—Ç</a>
                    <a href="#" data-value="–≠–∫—à–µ–Ω">–≠–∫—à–µ–Ω</a>
                    <a href="#" data-value="–ö–æ–º–µ–¥–∏—è">–ö–æ–º–µ–¥–∏—è</a>
                    <a href="#" data-value="–§—ç–Ω—Ç–µ–∑–∏">–§—ç–Ω—Ç–µ–∑–∏</a>
                    <a href="#" data-value="–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</a>
                    <a href="#" data-value="–î—Ä–∞–º–∞">–î—Ä–∞–º–∞</a>
                  </div>
                </div>
              </div>
              <!-- –¢–∏–ø -->
              <div class="filter-group">
                <label>–¢–∏–ø:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="animeTypeDropdownButton" data-selected="–õ—é–±–æ–π">–õ—é–±–æ–π</button>
                  <div class="dropdown-content" id="animeTypeDropdown">
                    <a href="#" data-value="–õ—é–±–æ–π">–õ—é–±–æ–π</a>
                    <a href="#" data-value="TV">–°–µ—Ä–∏–∞–ª</a>
                    <a href="#" data-value="Movie">–§–∏–ª—å–º</a>
                    <a href="#" data-value="OVA">OVA</a>
                    <a href="#" data-value="ONA">ONA</a>
                    <a href="#" data-value="Special">Special</a>
                  </div>
                </div>
              </div>
              <!-- –°—Ç–∞—Ç—É—Å -->
              <div class="filter-group">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="statusDropdownButton" data-selected="–õ—é–±–æ–π">–õ—é–±–æ–π</button>
                  <div class="dropdown-content" id="statusDropdown">
                    <a href="#" data-value="–õ—é–±–æ–π">–õ—é–±–æ–π</a>
                    <a href="#" data-value="–í—ã—Ö–æ–¥—è—â–∏–π">–í—ã—Ö–æ–¥—è—â–∏–π</a>
                    <a href="#" data-value="–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π</a>
                    <a href="#" data-value="–ê–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π">–ê–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</a>
                  </div>
                </div>
              </div>
              <!-- –ì–æ–¥ -->
              <div class="filter-group">
                <label>–ì–æ–¥:</label>
                <div class="year-slider">
                  <input type="range" id="yearFrom" min="1900" max="2025" value="2000" />
                  <input type="range" id="yearTo" min="1900" max="2025" value="2025" />
                </div>
                <div id="yearRangeText">–û—Ç 2000 –¥–æ 2025</div>
              </div>
              <!-- –†–µ–π—Ç–∏–Ω–≥ -->
              <div class="filter-group">
                <label>–†–µ–π—Ç–∏–Ω–≥:</label>
                <div class="rating-inputs">
                  <input type="number" id="ratingFrom" step="0.1" min="0" max="10" placeholder="–æ—Ç" />
                  <input type="number" id="ratingTo" step="0.1" min="0" max="10" placeholder="–¥–æ" />
                </div>
              </div>
              <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
              <div class="filter-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="sortDropdownButton" data-selected="–ù–∞–∑–≤–∞–Ω–∏—é">–ù–∞–∑–≤–∞–Ω–∏—é</button>
                  <div class="dropdown-content" id="sortDropdown">
                    <a href="#" data-value="–ù–∞–∑–≤–∞–Ω–∏—é">–ù–∞–∑–≤–∞–Ω–∏—é</a>
                    <a href="#" data-value="–î–∞—Ç–µ–î–æ–±–∞–≤–ª–µ–Ω–∏—è">–î–∞—Ç–µ –≤—ã—Ö–æ–¥–∞</a>
                    <a href="#" data-value="–†–µ–π—Ç–∏–Ω–≥—É">–†–µ–π—Ç–∏–Ω–≥—É</a>
                  </div>
                </div>
                <label>–ü–æ—Ä—è–¥–æ–∫:</label>
                <div class="dropdown">
                  <button class="dropbtn" id="orderDropdownButton" data-selected="–ü–æ–í–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                  <div class="dropdown-content" id="orderDropdown">
                    <a href="#" data-value="–ü–æ–í–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</a>
                    <a href="#" data-value="–ü–æ–£–±—ã–≤–∞–Ω–∏—é">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</a>
                  </div>
                </div>
              </div>
              <button id="applyFilters" class="filter-button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <footer>
      <div>
        <p>&copy; 2024 –ê–Ω–∏–º–µ–°–∞–π—Ç.</p>
        <p>
          <a href="https://t.me" style="color: white; text-decoration: none">–ù–∞—à –∫–∞–Ω–∞–ª –≤ Telegram</a> |
          <a href="about.html" style="color: white; text-decoration: none">–û –Ω–∞—Å</a> |
          <a href="add-item.html" style="color: white; text-decoration: none">–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–µ</a>
        </p>
      </div>
    </footer>

    <!-- =====================================================================================
         Script section. 2025‚Äë04‚Äë25 fix: ¬´–∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∂–∞–Ω—Ä–æ–≤¬ª + ¬´—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ¬ª
         ===================================================================================== -->
    <script>
      /* eslint-disable no-console */
      /*  anime-page.js ‚Äî Refactored on 2025‚Äë04‚Äë25 (bug‚Äëfix release)
          ----------------------------------------------------------
          ‚ú± Fixed: exclude‚Äëgenre param overwritten include param
          ‚ú± Fixed: dropdown dataset‚Äëvalue mismatch breaking sorting
          ‚ú± Added: unified mapBtn()/dropdown click handling
          ‚ú± Minor: default data-selected attributes for initial state
          ----------------------------------------------------------
      */

      (() => {
        'use strict';

        /* -------------------------------------------------------------------------
         * Constants & state
         * ---------------------------------------------------------------------- */
        const STORAGE_FAV_KEY = 'anime-favorites';
        const PAGE_SIZE = 8;

        const SELECTORS = {
          favCounter: '[aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"] .counter',
          cartCounter: '[aria-label="–ö–æ—Ä–∑–∏–Ω–∞"] .counter',
          yearFrom: '#yearFrom',
          yearTo: '#yearTo',
          yearRangeText: '#yearRangeText',
          dropdownLinks: '.dropdown-content a',
          searchInput: '#searchInput',
          suggestions: '#suggestions',
          searchContainer: '.search-container',
          results: '#results',
          pagination: '#pagination',
          applyFilters: '#applyFilters',
          searchForm: '#searchForm'
        };

        const state = {
          currentPage: 1
        };

        /* -------------------------------------------------------------------------
         * Utilities
         * ---------------------------------------------------------------------- */
        const $ = (sel, ctx = document) => ctx.querySelector(sel);
        const $$ = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];

        const debounce = (fn, delay = 300) => {
          let timer;
          return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(null, args), delay);
          };
        };

        /* ----------------- Local‚Äëstorage wrapper for favourites ----------------- */
        const favStore = {
          get() {
            try {
              return new Set(JSON.parse(localStorage.getItem(STORAGE_FAV_KEY)) || []);
            } catch {
              return new Set();
            }
          },
          save(set) {
            localStorage.setItem(STORAGE_FAV_KEY, JSON.stringify([...set]));
            updateFavCounter(set.size);
          },
          toggle(id) {
            const favs = this.get();
            favs.has(id) ? favs.delete(id) : favs.add(id);
            this.save(favs);
            return favs.has(id);
          }
        };

        /* ----------------------------- API helpers ----------------------------- */
        const api = {
          async suggestions(term) {
            const res = await fetch(`/api/anime/suggestions?searchTerm=${encodeURIComponent(term)}`);
            return res.ok ? res.json() : [];
          },
          async animes(query) {
            const res = await fetch(`/api/anime?${query}`);
            return res.ok ? res.json() : { items: [], totalPages: 0 };
          },
          cart: {
            async count() {
              const res = await fetch('/api/cart/count', { credentials: 'include' });
              return res.ok ? res.json() : { totalItems: 0 };
            },
            async add(id) {
              const res = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ animeId: id })
              });
              if (!res.ok) throw new Error(await res.text());
              return res.json();
            }
          }
        };

        /* ----------------------------- DOM helpers ----------------------------- */
        function updateFavCounter(count = favStore.get().size) {
          const el = $(SELECTORS.favCounter);
          if (el) el.textContent = count;
        }

        function updateCartCounter(count) {
          const el = $(SELECTORS.cartCounter);
          if (el) el.textContent = count;
        }

        function updateYearRangeText() {
          const from = parseInt($(SELECTORS.yearFrom).value, 10);
          const to = parseInt($(SELECTORS.yearTo).value, 10);
          $(SELECTORS.yearRangeText).textContent = `–û—Ç: ${Math.min(from, to)} –¥–æ: ${Math.max(from, to)}`;
        }

        /* ------------------------ Filter/Query collection ---------------------- */
        function mapBtn(id) {
          const btn = $(id);
          // dataset.selected is the canonical machine value (no spaces/ru‚Äëcamel) if present
          return btn.dataset.selected || btn.textContent.trim();
        }

        function getFilterParams() {
          const params = new URLSearchParams({ page: state.currentPage, pageSize: PAGE_SIZE });

          const term = $(SELECTORS.searchInput).value.trim();
          if (term) params.set('searchTerm', term);

          const includeGenre = mapBtn('#genreDropdownButton');
          const excludeGenre = mapBtn('#excludeGenreDropdownButton');
          const type = mapBtn('#animeTypeDropdownButton');
          const status = mapBtn('#statusDropdownButton');
          const sortKey = mapBtn('#sortDropdownButton');
          const orderKey = mapBtn('#orderDropdownButton');

          /* ---------- genres (include + exclude) ---------- */
          const genreTokens = [];
          if (includeGenre && includeGenre !== '–õ—é–±–æ–π') genreTokens.push(includeGenre);
          if (excludeGenre && excludeGenre !== '–ù–µ—Ç') genreTokens.push('!' + excludeGenre);
          if (genreTokens.length) params.set('genres', genreTokens.join(','));

          /* ---------- type / status ---------- */
          if (type && type !== '–õ—é–±–æ–π') params.set('type', type);
          if (status && status !== '–õ—é–±–æ–π') params.set('status', status);

          /* ---------- year ---------- */
          const yf = $(SELECTORS.yearFrom).value;
          const yt = $(SELECTORS.yearTo).value;
          if (yf) params.set('minYear', yf);
          if (yt) params.set('maxYear', yt);

          /* ---------- rating ---------- */
          const rf = $('#ratingFrom').value;
          const rt = $('#ratingTo').value;
          if (rf) params.set('minRating', rf);
          if (rt) params.set('maxRating', rt);

          /* ---------- sorting ---------- */
          const sortMap = {
            –ù–∞–∑–≤–∞–Ω–∏—é: 'Title',
            Title: 'Title',
            –î–∞—Ç–µ–î–æ–±–∞–≤–ª–µ–Ω–∏—è: 'ReleaseDate',
            '–î–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è': 'ReleaseDate',
            ReleaseDate: 'ReleaseDate',
            –†–µ–π—Ç–∏–Ω–≥—É: 'Rating',
            Rating: 'Rating'
          };
          if (sortMap[sortKey]) params.set('sortBy', sortMap[sortKey]);

          const orderMap = {
            –ü–æ–í–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é: 'asc',
            asc: 'asc',
            –ü–æ–£–±—ã–≤–∞–Ω–∏—é: 'desc',
            desc: 'desc'
          };
          params.set('order', orderMap[orderKey] || 'asc');

          return params.toString();
        }

        /* --------------------------- Rendering logic --------------------------- */
        function renderPagination(totalPages) {
          const container = $(SELECTORS.pagination);
          container.innerHTML = '';
          for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `page-btn${i === state.currentPage ? ' active' : ''}`;
            btn.addEventListener('click', () => {
              state.currentPage = i;
              loadAnimes();
            });
            container.appendChild(btn);
          }
        }

        function animeCardTemplate(a) {
          const isFav = favStore.get().has(a.id);
          return `
            <div class="anime-item" data-id="${a.id}">
            <img src="${a.imagePath}" alt="${a.title}" class="anime-img" />

            <div class="anime-info">
              <h3 class="title" title="${a.title}">${a.title}</h3>

              <div class="meta">
                <span class="rating">‚≠ê ${a.rating}</span>
                <span class="year">–ì–æ–¥: ${a.year}</span>
              </div>

              <div class="genre-info">–ñ–∞–Ω—Ä—ã: ${a.genres.join(' / ')}</div>

              <p class="description">${a.description ?? ''}</p>
            </div>

            <div class="actions">
              <button class="fav-btn" data-action="fav" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
                ${isFav ? 'üíî –£–±—Ä–∞—Ç—å' : 'üíú –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}
              </button>
            </div>
          </div>`;
        }

        function renderAnimes(items) {
          const container = $(SELECTORS.results);
          if (!items.length) {
            container.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
            return;
          }
          container.innerHTML = items.map(animeCardTemplate).join('');
        }

        /* ------------------------- Event handler bundle ------------------------ */
        function bindUIEvents() {
          // Year range text
          $$(`${SELECTORS.yearFrom}, ${SELECTORS.yearTo}`).forEach(el =>
            el.addEventListener('input', updateYearRangeText)
          );

          // Dropdown selection (single delegated handler)
          $$(SELECTORS.dropdownLinks).forEach(link =>
            link.addEventListener('click', e => {
              e.preventDefault();
              const dd = e.target.closest('.dropdown');
              const btn = dd.querySelector('.dropbtn');
              btn.textContent = e.target.textContent.trim(); // human‚Äëfriendly label
              // Machine value (dataset.value) falls back to trimmed text
              btn.dataset.selected = e.target.dataset.value || e.target.textContent.trim();
            })
          );

          // Search suggestions
          $(SELECTORS.searchInput).addEventListener(
            'input',
            debounce(async e => {
              const term = e.target.value;
              const box = $(SELECTORS.suggestions);
              if (!term.trim()) return box.classList.remove('visible');
              const list = await api.suggestions(term);
              if (!list.length) return box.classList.remove('visible');
              box.innerHTML = list
                .map(i => `<li role="option" data-id="${i.id}">${i.title}</li>`)
                .join('');
              box.classList.add('visible');
            }, 250)
          );

          // Suggestion click
          $(SELECTORS.suggestions).addEventListener('click', e => {
            if (e.target.tagName !== 'LI') return;
            $(SELECTORS.searchInput).value = e.target.textContent;
            $(SELECTORS.suggestions).classList.remove('visible');
            state.currentPage = 1;
            loadAnimes();
          });

          // Click outside search container hides suggestions
          document.addEventListener('click', e => {
            if (!e.target.closest(SELECTORS.searchContainer)) $(SELECTORS.suggestions).classList.remove('visible');
          });

          // Apply filters / new search
          $(SELECTORS.applyFilters).addEventListener('click', () => {
            state.currentPage = 1;
            loadAnimes();
          });
          $(SELECTORS.searchForm).addEventListener('submit', e => {
            e.preventDefault();
            state.currentPage = 1;
            loadAnimes();
          });

          // Delegated actions in results
          $(SELECTORS.results).addEventListener('click', async e => {
            const action = e.target.dataset.action;
            const card = e.target.closest('.anime-item');
            if (!card) return;
            const id = Number(card.dataset.id);

            switch (action) {
              case 'cart':
                try {
                  const { totalItems } = await api.cart.add(id);
                  updateCartCounter(totalItems);
                } catch (err) {
                  console.error(err);
                  alert(err.message);
                }
                break;
              case 'fav':
                {
                  const isFav = favStore.toggle(id);
                  e.target.textContent = isFav ? 'üíî –£–±—Ä–∞—Ç—å' : 'üíú –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                }
                break;
              default:
                window.location.href = `anime.html?id=${id}`;
            }
          });
        }

        /* ------------------------------ Data flow ------------------------------ */
        async function loadAnimes() {
          const { items, totalPages } = await api.animes(getFilterParams());
          renderAnimes(items);
          renderPagination(totalPages);
        }

        async function loadCartCount() {
          try {
            const { totalItems } = await api.cart.count();
            updateCartCounter(totalItems);
          } catch {
            updateCartCounter(0);
          }
        }

        /* -------------------------------- Start -------------------------------- */
        document.addEventListener('DOMContentLoaded', () => {
          bindUIEvents();
          updateYearRangeText();
          updateFavCounter();
          loadAnimes();
          loadCartCount();
        });
      })();
    </script>
  </body>
</html>
