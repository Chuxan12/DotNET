<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ | –ê–Ω–∏–º–µ–°–∞–π—Ç</title>
    <link rel="stylesheet" href="css/styles.css"/>
    <style>
        .fav-container {
            max-width: 1200px;
            margin: auto;
            padding: 20px
        }

        .fav-empty {
            text-align: center;
            font-size: 20px;
            margin: 40px 0
        }

        .anime-card {
            display: flex;
            gap: 20px;
            background: #fff;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08)
        }

        .anime-card img {
            width: 160px;
            border-radius: 6px;
            object-fit: cover
        }

        .anime-meta h3 {
            margin: 0 0 8px
        }

        .remove-btn {
            margin-top: 10px;
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer
        }

        .remove-btn:hover {
            background: #c0392b
        }
    </style>
</head>

<body>
<header class="site-header">
    <div class="logo">–ê–Ω–∏–º–µ–°–∞–π—Ç</div>

    <div class="search-container" role="search">
        <form id="searchForm" class="search-form" autocomplete="off" aria-label="–ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ">
            <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="–ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                    aria-autocomplete="list"
                    aria-controls="suggestions"
                    aria-expanded="false"
            />
            <button type="submit" class="search-button" aria-label="–ù–∞–π—Ç–∏">üîç</button>
        </form>
        <ul id="suggestions" class="autocomplete-suggestions" role="listbox" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞"></ul>
    </div>

    <nav class="main-nav" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
        <ul>
            <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li><a href="top100.html">–¢–æ–ø-100 –∞–Ω–∏–º–µ</a></li>
            <a href="cart.html" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="counter">0</span> </a>
            <li>
                <a href="profile.html" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
                    <img src="img/avatar.jpg" alt="" class="avatar"/>
                </a>
            </li>
        </ul>
    </nav>
</header>

<main class="fav-container">
    <h1>–ú–æ—ë –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>
    <div id="favList"></div>
</main>

<footer>
    <div>
        <p>&copy; 2024 –ê–Ω–∏–º–µ–°–∞–π—Ç.</p>
        <p>
            <a href="https://t.me" style="color: white; text-decoration: none">–ù–∞—à –∫–∞–Ω–∞–ª –≤ Telegram</a> |
            <a href="about.html" style="color: white; text-decoration: none">–û –Ω–∞—Å</a> |
            <a href="add-item.html" style="color: white; text-decoration: none">–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–µ</a>
        </p>
    </div>
</footer>

<script type="module">
    /* ---------- –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ / –∫–æ—Ä–∑–∏–Ω—ã --------------- */
    import {getFavSet, saveFavSet, updateFavCounter} from './js/fav-storage.js';

    updateFavCounter();

    /* ---------- –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ --------------- */
    document.addEventListener('DOMContentLoaded', async () => {
        const listEl = document.getElementById('favList');
        const ids = [...getFavSet()];

        if (!ids.length) {
            listEl.innerHTML = '<p class="fav-empty">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</p>';
            return;
        }

        for (const id of ids) {
            try {
                const res = await fetch(`/api/anime/${id}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const a = await res.json();
                listEl.appendChild(renderCard(a));
            } catch {
                /* –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ —É–∂–µ –Ω–µ—Ç –≤ –±–∞–∑–µ, —É–¥–∞–ª—è–µ–º id –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ */
                const set = getFavSet();
                set.delete(id);
                saveFavSet(set);
            }
        }

        if (!listEl.children.length)
            listEl.innerHTML = '<p class="fav-empty">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</p>';
    });

    /* ---------- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ --------------- */
    function renderCard(a) {
        const card = document.createElement('div');
        card.className = 'anime-card';
        card.dataset.id = a.id;

        card.innerHTML = `
        <img src="${a.imagePath || 'img/placeholder.png'}" alt="${a.title}">
        <div class="anime-meta">
          <h3>${a.title}</h3>
          <p>‚≠ê ${a.rating} &nbsp;|&nbsp; ${a.year}</p>
          <p>${a.genres.join(' / ')}</p>
          <button class="remove-btn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
        return card;
    }

    /* ---------- —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ --------------- */
    document.addEventListener('click', e => {
        if (!e.target.classList.contains('remove-btn')) return;

        const card = e.target.closest('.anime-card');
        const id = +card.dataset.id;
        card.remove();

        const set = getFavSet();
        set.delete(id);
        saveFavSet(set);          // ‚á¶ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –∏ –≤—ã–≤–µ–¥–µ—Ç —Å—á—ë—Ç—á–∏–∫

        if (!document.querySelector('.anime-card')) {
            document.getElementById('favList').innerHTML =
                '<p class="fav-empty">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</p>';
        }
    });
</script>
</body>
</html>